<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Chat Debug Client</title>
  <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
  <style>
      /* ìŠ¤íƒ€ì¼ ì¢€ ë” ê¹”ë”í•˜ê²Œ */
      body { font-family: 'Segoe UI', sans-serif; max-width: 900px; margin: 20px auto; padding: 20px; background: #f0f2f5; }
      .container { display: flex; gap: 20px; }
      .control-panel { flex: 1; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
      .log-panel { flex: 2; background: #1e1e1e; color: #00ff00; padding: 20px; border-radius: 8px; height: 500px; overflow-y: auto; font-family: monospace; }
      input, button { width: 100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box; }
      button { background: #007bff; color: white; border: none; cursor: pointer; font-weight: bold; }
      button:hover { background: #0056b3; }
      button.disconnect { background: #dc3545; }
      .status { margin-bottom: 10px; font-weight: bold; color: #dc3545; }
      .status.connected { color: #28a745; }
  </style>
</head>
<body>
<h1>ğŸš€ NestJS ì±„íŒ… ë””ë²„ê±°</h1>

<div class="container">
  <div class="control-panel">
    <div id="status" class="status">ğŸ”´ ì—°ê²° ëŠê¹€</div>

    <h3>1. ì¸ì¦ (JWT)</h3>
    <input type="text" id="token" placeholder="Bearer Token ì…ë ¥ (ey...)" />
    <button onclick="connectSocket()">ì†Œì¼“ ì—°ê²° (Connect)</button>
    <button class="disconnect" onclick="disconnectSocket()">ì—°ê²° ëŠê¸°</button>

    <hr>

    <h3>2. ë°© ì…ì¥</h3>
    <input type="number" id="roomId" value="1" placeholder="ë°© ë²ˆí˜¸" />
    <button onclick="joinRoom()">ë°© ì…ì¥ (Join)</button>

    <hr>

    <h3>3. ë©”ì‹œì§€ ì „ì†¡</h3>
    <input type="text" id="msgInput" placeholder="ë©”ì‹œì§€ ì…ë ¥..." onkeypress="if(event.keyCode==13) sendMessage()" />
    <button onclick="sendMessage()">ì „ì†¡ (Send)</button>
  </div>

  <div class="log-panel" id="logs">
    <div>[System] ëŒ€ê¸° ì¤‘...</div>
  </div>
</div>

<script>
  let socket = null;

  // í™”ë©´ì— ë¡œê·¸ ì°ëŠ” í•¨ìˆ˜
  function log(type, msg) {
    const logBox = document.getElementById('logs');
    const p = document.createElement('div');
    const time = new Date().toLocaleTimeString();

    let color = 'white';
    if (type === 'SEND') color = '#f1c40f'; // ë…¸ë‘
    if (type === 'RECV') color = '#3498db'; // íŒŒë‘
    if (type === 'ERR') color = '#e74c3c';  // ë¹¨ê°•

    p.style.color = color;
    p.textContent = `[${time}] [${type}] ${msg}`;
    logBox.appendChild(p);
    logBox.scrollTop = logBox.scrollHeight;
  }

  function updateStatus(isConnected) {
    const el = document.getElementById('status');
    el.textContent = isConnected ? 'ğŸŸ¢ ì„œë²„ ì—°ê²°ë¨' : 'ğŸ”´ ì—°ê²° ëŠê¹€';
    el.className = isConnected ? 'status connected' : 'status';
  }

  // 1. ì†Œì¼“ ì—°ê²°
  function connectSocket() {
    const token = document.getElementById('token').value.trim();
    if (!token) return alert('í† í°ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”!');

    if (socket) {
      socket.disconnect();
    }

    log('System', 'ì„œë²„ ì—°ê²° ì‹œë„ ì¤‘...');

    // ì†Œì¼“ ì´ˆê¸°í™”
    socket = io('http://localhost:3000/chat', {
      transports: ['websocket'], // í´ë§ ë°©ì§€ (ì¦‰ì‹œ ì›¹ì†Œì¼“)
      auth: {
        token: `Bearer ${token}`
      },
      // ë§Œì•½ Gatewayì—ì„œ í—¤ë”ë¡œ ê²€ì‚¬í•˜ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ
      // extraHeaders: { Authorization: `Bearer ${token}` }
    });

    // ì—°ê²° ì„±ê³µ ì´ë²¤íŠ¸
    socket.on('connect', () => {
      updateStatus(true);
      log('System', `âœ… ì—°ê²° ì„±ê³µ! (Socket ID: ${socket.id})`);
    });

    // ì—°ê²° ëŠê¹€
    socket.on('disconnect', (reason) => {
      updateStatus(false);
      log('ERR', `âŒ ì—°ê²° ëŠê¹€ (${reason})`);
    });

    // ì—ëŸ¬ ë°œìƒ (ì¸ì¦ ì‹¤íŒ¨ ë“±)
    socket.on('connect_error', (error) => {
      updateStatus(false);
      log('ERR', `ğŸ”¥ ì—°ê²° ì—ëŸ¬: ${error.message}`);
      alert('ì—°ê²° ì‹¤íŒ¨! í† í°ì„ í™•ì¸í•˜ê±°ë‚˜ ì„œë²„ ë¡œê·¸ë¥¼ ë³´ì„¸ìš”.');
    });

    // â˜… ë©”ì‹œì§€ ìˆ˜ì‹  (ì„œë²„ê°€ emit('message') í•œ ê²ƒ)
    socket.on('message', (data) => {
      console.log('ë°›ì€ ë°ì´í„°:', data); // F12 ì½˜ì†”ì—ì„œë„ í™•ì¸
      log('RECV', `[User ${data.user}] ${data.message} (${data.time})`);
    });

    // ê³µì§€ì‚¬í•­ ìˆ˜ì‹  (join ì„±ê³µ ë“±)
    socket.on('notice', (msg) => {
      log('RECV', `ğŸ“¢ ê³µì§€: ${msg}`);
    });
  }

  function disconnectSocket() {
    if (socket) {
      socket.disconnect();
      log('System', 'ì‚¬ìš©ìê°€ ì—°ê²°ì„ ëŠì—ˆìŠµë‹ˆë‹¤.');
    }
  }

  // 2. ë°© ì…ì¥
  function joinRoom() {
    if (!socket || !socket.connected) return alert('ë¨¼ì € ì†Œì¼“ ì—°ê²°ì„ í•´ì£¼ì„¸ìš”!');
    const roomId = document.getElementById('roomId').value;

    socket.emit('join_room', parseInt(roomId)); // ì„œë²„ ì´ë²¤íŠ¸ëª… í™•ì¸ í•„ìš”
    log('SEND', `ğŸšª ${roomId}ë²ˆ ë°© ì…ì¥ ìš”ì²­ ë³´ëƒ„`);
  }

  // 3. ë©”ì‹œì§€ ì „ì†¡
  function sendMessage() {
    if (!socket || !socket.connected) return alert('ë¨¼ì € ì†Œì¼“ ì—°ê²°ì„ í•´ì£¼ì„¸ìš”!');

    const roomId = document.getElementById('roomId').value;
    const msg = document.getElementById('msgInput').value;

    if(!msg) return;

    // ì„œë²„ ì´ë²¤íŠ¸ëª… 'message' í™•ì¸ í•„ìš”
    socket.emit('message', { room: parseInt(roomId), msg: msg });
    log('SEND', `ğŸ“¤ ë©”ì‹œì§€ ì „ì†¡: ${msg}`);

    document.getElementById('msgInput').value = ''; // ì…ë ¥ì°½ ë¹„ìš°ê¸°
  }
</script>
</body>
</html>